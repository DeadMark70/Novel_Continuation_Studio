# Debug Notes & Optimization Guide

> æœ¬æ–‡æª”è¨˜éŒ„äº† 2026-01-29 çš„èª¿è©¦éç¨‹ã€ç™¼ç¾çš„å•é¡Œã€è§£æ±ºæ–¹æ¡ˆï¼Œä»¥åŠæœªä¾†å„ªåŒ–å»ºè­°ã€‚

---

## ğŸ› å•é¡Œæ‘˜è¦

### æœ€åˆå ±å‘Šçš„ç—‡ç‹€

ç”¨æˆ¶å ±å‘Šï¼šã€Œç³»çµ±åœ¨ AI é‚„æ²’å›æ‡‰å®Œæˆæ™‚å°±è·³åˆ°ä¸‹ä¸€æ­¥é©Ÿã€

### å¯¦éš›æ ¹æœ¬åŸå› 

**ä¸æ˜¯ç«¶æ…‹æ¢ä»¶ï¼Œè€Œæ˜¯ API éŒ¯èª¤è™•ç†å•é¡Œï¼š**

1. ç•¶å°èªªå…§å®¹éé•·æ™‚ï¼ŒAPI è¿”å›éŒ¯èª¤ï¼š
   ```
   The input (11567 tokens) is longer than the model's context length (8192 tokens).
   ```
2. API éŒ¯èª¤ä»¥ HTTP 200 ç‹€æ…‹ç¢¼è¿”å›ï¼ˆé€™æ˜¯ API ç«¯çš„å•é¡Œè¨­è¨ˆï¼‰
3. éŒ¯èª¤å°è±¡åœ¨ SSE stream ä¸­è¿”å›ï¼Œä½†åŸä»£ç¢¼æ²’æœ‰æª¢æ¸¬
4. ç³»çµ±å°‡ç©ºéŸ¿æ‡‰è¦–ç‚ºã€Œå®Œæˆã€ä¸¦è§¸ç™¼ä¸‹ä¸€æ­¥

---

## ğŸ” èª¿è©¦éç¨‹ä¸­ç™¼ç¾çš„é—œéµé»

### 1. SSE éŒ¯èª¤è™•ç†ä¸å®Œå–„

**æ–‡ä»¶**: `lib/nim-client.ts`

**å•é¡Œ**: åŸä»£ç¢¼åªæª¢æ¸¬ `delta.content`ï¼Œæ²’æœ‰è™•ç†éŒ¯èª¤å°è±¡

**ä¿®å¾©**:

```typescript
// âœ… Check if API returned an error object
if (json.error) {
  const errorMessage =
    json.error.message || json.error.type || "Unknown API error";
  throw new Error(`API Error: ${errorMessage}`);
}
```

### 2. å¤šçµ„ä»¶å…±äº«ç‹€æ…‹éœ€è¦å…¨å±€ Store

**æ–‡ä»¶**: `hooks/useStepGenerator.ts`, `store/useWorkflowStore.ts`

**å•é¡Œ**: `useRef` åœ¨æ¯å€‹çµ„ä»¶å¯¦ä¾‹ä¸­æ˜¯ç¨ç«‹çš„ï¼Œå°è‡´å¤šå€‹çµ„ä»¶ç„¡æ³•å…±äº«é–ç‹€æ…‹

**ä¿®å¾©**: å°‡ `isGenerating` ç§»åˆ° Zustand storeï¼š

```typescript
// store/useWorkflowStore.ts
isGenerating: boolean;
setIsGenerating: (value: boolean) => void;
```

### 3. è‡ªå‹•åŒ–æµç¨‹éœ€è¦å¤šé‡ä¿è­·

**æ–‡ä»¶**: `components/WorkflowStepper.tsx`

**ä¿è­·æ©Ÿåˆ¶**:

- æª¢æŸ¥å…¨å±€ `isGenerating` é–
- æª¢æŸ¥æ˜¯å¦æœ‰æ­¥é©Ÿæ­£åœ¨ streaming
- setTimeout å…§éƒ¨äºŒæ¬¡æª¢æŸ¥
- å…§å®¹é©—è­‰ï¼ˆç¢ºä¿è¼¸å‡ºä¸ç‚ºç©ºï¼‰

---

## ğŸ“Š ç•¶å‰æ¶æ§‹çš„æ•¸æ“šæµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Component   â”‚â”€â”€â”€â–¶â”‚ useStepGenerator â”‚â”€â”€â”€â–¶â”‚ generateStream  â”‚
â”‚  (StepOutline)  â”‚    â”‚     (Hook)       â”‚    â”‚  (nim-client)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚                        â”‚
        â”‚                      â–¼                        â”‚
        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
        â”‚              â”‚ useWorkflowStore â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚   (Zustand)      â”‚      SSE chunks
        â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â”‚                      â–¼
        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  useNovelStore   â”‚ (æŒä¹…åŒ–)
                       â”‚   (Zustand)      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### Token é™åˆ¶

| æ¨¡å‹          | Context Length |
| ------------- | -------------- |
| æŸäº›æ¨¡å‹      | 8,192 tokens   |
| deepseek-chat | 32K+ tokens    |

**æ³¨æ„**: 8000 å­—ä¸­æ–‡ç´„ ~11,000 tokensï¼Œå¾ˆå®¹æ˜“è¶…é™

### API è¡Œç‚º

- éŒ¯èª¤å¯èƒ½ä»¥ HTTP 200 è¿”å›ä½† body åŒ…å«éŒ¯èª¤å°è±¡
- Thinking mode æ¨¡å‹å¯èƒ½éœ€è¦ 30-60 ç§’æ‰é–‹å§‹è¼¸å‡ºç¬¬ä¸€å€‹ token

---

## ğŸš€ å„ªåŒ–å»ºè­°

### é«˜å„ªå…ˆç´š

1. **Token è¨ˆç®—é æª¢**
   - åœ¨ç™¼é€è«‹æ±‚å‰ä¼°ç®— token æ•¸é‡
   - è¶…é™æ™‚æç¤ºç”¨æˆ¶æˆ–è‡ªå‹•æˆªæ–·

   ```typescript
   // å»ºè­°æ·»åŠ åˆ° prompt-engine.ts
   function estimateTokens(text: string): number {
     // ä¸­æ–‡ç´„ 1 å­— = 1.5 tokens
     return Math.ceil(text.length * 1.5);
   }
   ```

2. **æ›´å¥½çš„éŒ¯èª¤æç¤º UI**
   - é¡¯ç¤ºå…·é«”éŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶
   - æä¾›è§£æ±ºæ–¹æ¡ˆå»ºè­°ï¼ˆå¦‚åˆ‡æ›æ¨¡å‹ï¼‰

3. **ç§»é™¤èª¿è©¦ä»£ç¢¼**
   - `useStepGenerator.ts` ä¸­çš„ `alert()` éœ€è¦ç§»é™¤
   - æ¸›å°‘ console.log è¼¸å‡ºï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

### ä¸­å„ªå…ˆç´š

4. **è«‹æ±‚è¶…æ™‚å„ªåŒ–**
   - ç•¶å‰è¶…æ™‚è¨­ç½®: 60 ç§’
   - Thinking mode æ¨¡å‹å¯èƒ½éœ€è¦æ›´é•·æ™‚é–“
   - å»ºè­°: å‹•æ…‹èª¿æ•´æˆ–é¡¯ç¤ºç­‰å¾…æç¤º

5. **è‡ªå‹•é‡è©¦æ©Ÿåˆ¶**
   - ç¶²çµ¡éŒ¯èª¤æ™‚è‡ªå‹•é‡è©¦ 1-2 æ¬¡
   - ä½¿ç”¨ exponential backoff

6. **é•·æ–‡æœ¬åˆ†æ®µè™•ç†**
   - è‡ªå‹•å°‡é•·å°èªªåˆ†æ®µ
   - åˆ†æ®µç”Ÿæˆåˆ†æ/å¤§ç¶±

### ä½å„ªå…ˆç´š

7. **ç‹€æ…‹æŒä¹…åŒ–å„ªåŒ–**
   - æ¸›å°‘ IndexedDB å¯«å…¥é »ç‡
   - ä½¿ç”¨ debounce

8. **UI åé¥‹å„ªåŒ–**
   - é¡¯ç¤ºç•¶å‰ token ä½¿ç”¨é‡
   - é€²åº¦æŒ‡ç¤ºå™¨æ”¹é€²

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### å¿…æ¸¬å ´æ™¯

1. âœ… çŸ­æ–‡æœ¬ (~2000 å­—) - æ‡‰æ­£å¸¸å®Œæˆå…¨æµç¨‹
2. âœ… é•·æ–‡æœ¬ (>8000 å­—) - æ‡‰é¡¯ç¤ºæ˜ç¢ºéŒ¯èª¤è¨Šæ¯
3. âœ… æ‰‹å‹•åœæ­¢ç”Ÿæˆ - æ‡‰æ­£ç¢ºé‡‹æ”¾é–
4. âœ… ç¶²çµ¡æ–·é–‹ - æ‡‰é¡¯ç¤ºéŒ¯èª¤ï¼Œä¸å¡ä½

### èª¿è©¦æŠ€å·§

1. é–‹å•Ÿ Console æŸ¥çœ‹ `[Generator]` å’Œ `[SSE]` å‰ç¶´çš„æ—¥èªŒ
2. æª¢æŸ¥ `isGenerating` ç‹€æ…‹ï¼ˆReact DevTools > Zustandï¼‰
3. ç¶²çµ¡é¢æ¿æŸ¥çœ‹ API è«‹æ±‚/éŸ¿æ‡‰

---

## ğŸ“ ç›¸é—œæ–‡ä»¶

| æ–‡ä»¶                             | è·è²¬                   |
| -------------------------------- | ---------------------- |
| `lib/nim-client.ts`              | SSE ä¸²æµè™•ç†ã€éŒ¯èª¤æª¢æ¸¬ |
| `hooks/useStepGenerator.ts`      | ç”Ÿæˆæµç¨‹æ§åˆ¶ã€é–ç®¡ç†   |
| `store/useWorkflowStore.ts`      | å…¨å±€ç‹€æ…‹ã€è‡ªå‹•åŒ–é‚è¼¯   |
| `store/useNovelStore.ts`         | å°èªªæ•¸æ“šæŒä¹…åŒ–         |
| `components/WorkflowStepper.tsx` | è‡ªå‹•è§¸ç™¼é‚è¼¯           |

---

_æœ€å¾Œæ›´æ–°: 2026-01-29_
