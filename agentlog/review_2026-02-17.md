# 審查結果（依嚴重度）

1. [High][Done V1] E2E 韌性測試已失真，造成 CI 失敗：`e2e/resilience.spec.js:29` 還在找 `Generate & Continue|Generate Outline`，但實際按鈕文案已變成 `Generate 2A+2B`（`components/workflow/StepOutline.tsx:240`）。這是目前 `npm run e2e` 12/13 通過、1 失敗的直接原因。
2. [High][Done V1] 流式生成期間存在高頻全域重渲染風險：多個核心元件直接 `useWorkflowStore()` 讀整個 store，會在每次 chunk 更新時一起重渲染，例如 `components/WorkflowStepper.tsx:21`、`components/workflow/StepAnalysis.tsx:17`、`components/workflow/StepOutline.tsx:36`、`components/workflow/StepContinuation.tsx:18`。這和專案先前「避免 broad subscription」目標相衝突。
3. [High][Done V1] 輸入時即時落盤，容易造成寫入放大與卡頓：`components/StoryUpload.tsx:22` 每次輸入都呼叫 `setNovel`，而 `setNovel` 會立刻 `persist`（`store/useNovelStore.ts:183`），`persist` 又是整筆 session 寫入（`store/useNovelStore.ts:478`）。長文本貼上/編輯時會放大 I/O。
4. [Medium][Done V1] `currentStepId` 可能進入無效值（空字串）：Accordion 可收合時，`onValueChange` 直接 cast（`components/WorkflowStepper.tsx:107`），store 也無防呆（`store/useWorkflowStore.ts:389`），而暫停邏輯會用它做取消（`store/useWorkflowStore.ts:431`）。可能導致狀態污染與不可預期流程。
5. [Medium][Done V2] 可及性問題：列表列項是可點擊 div，非鍵盤可操作控制：`components/workflow/VersionList.tsx:107` + `components/workflow/VersionList.tsx:116`。滑鼠可用，但鍵盤/螢幕閱讀器語義不足。
6. [Medium][Done V3] 建置在離線/受限網路不穩定：`app/layout.tsx:2`、`app/layout.tsx:5`、`app/layout.tsx:10` 使用 `next/font/google`，`npm run build` 實測會因抓不到 Google Fonts 失敗。
7. [Medium][Done V4] 關鍵生成核心測試覆蓋不足：`hooks/useStepGenerator.ts:277` 起的大量流程邏輯，在 coverage 報告僅約 `3.18%` statements，屬高風險區。
8. [Medium][Done V3] 文件與實作漂移：文件仍寫 schema v7（`conductor/product.md:45`、`conductor/tech-stack.md:21`、`agent.md:27`），實作已到 v11（`lib/db.ts:395`）。維護與交接容易誤判。
9. [Medium-Low][Done V2] 多處使用阻塞式 `alert/confirm`，UX 不一致且可及性較差：`components/StoryUpload.tsx:31`、`components/StoryUpload.tsx:91`、`app/settings/page.tsx:453`、`components/workflow/StepAnalysis.tsx:53`、`components/workflow/StepOutline.tsx:201`。
10. [Low][Done V3] 語系標記與介面語言不一致：HTML `lang="en"`（`app/layout.tsx:29`），但大量 UI 為中文（如 `app/page.tsx:71`）。對 i18n 與輔助工具不理想。
11. [Low][Done V1] Lint 警告仍存在：`store/useNovelStore.ts:248`、`store/useNovelStore.ts:274`（未使用變數）。
12. [Low][Done V3] 頁面缺口：目前缺少 `app/error.tsx`、`app/not-found.tsx`，異常頁/404 體驗仍是預設行為。

## 修正進度（2026-02-17）

1. `V1 穩定性與效能`：✅ 完成（項次 1, 2, 3, 4, 11）
2. `V2 可及性與互動一致性`：✅ 完成（項次 5, 9）
3. `V3 建置/文件/頁面完整性`：✅ 完成（項次 6, 8, 10, 12）
4. `V4 測試覆蓋提升`：✅ 完成（項次 7）

## 驗證結果

1. `npx tsc --noEmit`：通過。
2. `npm run lint`：通過但有 6 個 warning（`useNovelStore.ts`）。
3. `$env:CI='true'; npm test`：40 files / 177 tests 全通過。
4. `npm run e2e`：13 項中 12 通過、1 失敗（`e2e/resilience.spec.js` Flow A）。
5. `npm run build`：失敗（Google Fonts 無法抓取）。
6. `$env:CI='true'; npx vitest run --coverage`：全綠，但整體 coverage 約 60.6%，`useStepGenerator.ts` 覆蓋偏低。

## 實作後驗證（2026-02-17）

1. `npx tsc --noEmit`：通過。
2. `npm run lint`：通過（無 warning）。
3. `$env:CI='true'; npx vitest run __tests__/useNovelStore.test.ts`：11/11 通過。
4. `$env:CI='true'; npx vitest run __tests__/StepAnalysis.test.tsx __tests__/StepOutline.test.tsx __tests__/StoryUpload.test.tsx __tests__/VersionList.test.tsx`：15/15 通過。
5. `npm run build`：通過（已不依賴 Google Fonts 線上下載）。
6. `$env:CI='true'; npx vitest run --coverage`：183 tests 全綠，整體 coverage 約 `66.34%`，`useStepGenerator.ts` statements 約 `34.66%`（由審查時 `3.18%` 顯著提升）。

## 假設與待確認

1. `StepOutline` 的按鈕改名（`Generate 2A+2B`）是預期產品決策，而非暫時文案。
2. `normalizeNovelText` 的標點/空白正規化（`lib/utils.ts:11`）是刻意設計，不是資料保真需求。
3. 你們是否需要「可離線 build」作為正式要求（目前會被字型下載阻斷）。

## 補充

1. 原始審查階段未修改檔案；本文件目前已加入 2026-02-17 的實作修正進度與完成標記。
2. UI 檢查基準使用了 `web-design-guidelines` 最新規範來源：https://raw.githubusercontent.com/vercel-labs/web-interface-guidelines/main/command.md

## 建議下一步（可直接幫你落地）

1. 已完成：`review_2026-02-17` 原列 12 項皆已落地並標記版本完成狀態。
2. 建議下一步：補 `hooks/useStepGenerator.ts` 其餘高複雜分支（Phase 0 pipeline、Phase 3 chunk 管線）的精準測試，持續拉升覆蓋率。
3. 建議下一步：為 `app/error.tsx`、`app/not-found.tsx` 補一組簡單渲染/導頁測試，鎖定頁面完整性回歸。
